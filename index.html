<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>경영혁신활동시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #f4f7f6;
        }
        /* 탭 스타일 */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-link {
            transition: all 0.3s ease;
        }
        .tab-link.active {
            border-bottom-color: #2563eb; /* blue-600 */
            color: #2563eb;
            font-weight: 600;
        }
        /* 테이블 폰트 굵기 및 가독성 개선 */
        th {
            font-weight: 600; /* semibold */
            color: #374151; /* gray-700 */
        }
        td {
            font-weight: 500; /* medium */
            color: #1f2937; /* gray-800 */
        }
        /* 버튼 공통 스타일 */
        .btn {
            @apply inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-primary {
            @apply text-white bg-blue-600 hover:bg-blue-700 focus:ring-blue-500;
        }
        .btn-secondary {
            @apply text-gray-700 bg-white hover:bg-gray-50 border-gray-300 focus:ring-indigo-500;
        }
        .btn-danger {
            @apply text-white bg-red-600 hover:bg-red-700 focus:ring-red-500;
        }
        
        /* 모달 스타일 */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            max-height: 90vh;
        }
        
        /* 로그인 화면 스타일 */
        #role-selection-overlay {
            background-color: rgba(244, 247, 246, 0.9);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="antialiased">

    <!-- 0. 로그인 모드 선택 오버레이 -->
    <div id="role-selection-overlay" class="fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-white p-10 rounded-lg shadow-2xl text-center max-w-md w-full">
            <h2 class="text-2xl font-bold mb-3 text-gray-800">경영혁신활동시스템</h2>
            <p class="text-gray-600 mb-8">로그인 모드를 선택하세요.</p>
            <div class="space-y-4">
                <button id="admin-login-btn" class="w-full btn btn-primary py-3 text-base">
                    관리자 모드
                </button>
                <button id="user-login-btn" class="w-full btn btn-secondary py-3 text-base">
                    담당자 모드
                </button>
            </div>
        </div>
    </div>

    <!-- 1. 메인 앱 컨테이너 (초기 숨김) -->
    <div id="main-app-container" class="hidden min-h-screen">

        <!-- 헤더 -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">경영혁신활동시스템</h1>
                    <p id="app-subtitle" class="text-sm text-gray-500">실시간 과제 현황 모니터링</p>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- 관리자 전용 UI (시뮬레이션) -->
                    <div id="admin-only-controls" class="hidden flex items-center space-x-2">
                        <button id="run-simulation-btn" class="btn btn-secondary text-xs">시뮬레이션: 데이터 생성</button>
                        <button id="delete-all-btn" class="btn btn-danger text-xs">시뮬레이션: 전체 삭제</button>
                    </div>
                     <!-- 공용 UI (로그아웃, App ID) -->
                    <button id="export-logout-btn" class="btn btn-secondary text-xs">데이터 저장 & 로그아웃</button>
                    <span class="text-xs text-gray-500">App ID: <strong id="app-id-display" class="text-blue-600">...</strong></span>
                </div>
            </div>
        </header>

        <!-- 탭 네비게이션 -->
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <a href="#" class="tab-link active py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="tab-projects">과제 운영 (프로젝트)</a>
                    <a href="#" class="tab-link py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="tab-summary">법인별 요약 (대시보드)</a>
                    <a href="#" class="tab-link py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="tab-belt">벨트 요약 (인원)</a>
                    <a href="#" class="tab-link py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="tab-progress">진척율 현황 대시보드</a>
                </div>
            </div>
        </nav>

        <!-- 메인 컨텐츠 -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

            <!-- 탭 1: 과제 운영 (프로젝트) -->
            <div id="tab-projects" class="tab-content active">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">과제 운영 현황</h2>
                    <div class="flex space-x-2">
                        <button id="download-csv-btn" class="btn btn-secondary">견본 CSV 다운로드</button>
                        <div class="relative">
                            <button id="upload-csv-btn" class="btn btn-secondary">CSV 일괄 업로드</button>
                            <input type="file" id="csv-upload-input" class="hidden" accept=".csv">
                        </div>
                        <button id="new-project-btn" class="btn btn-primary">신규 과제 등록</button>
                    </div>
                </div>
                <div id="upload-status" class="mb-4 text-sm text-gray-600"></div>

                <!-- 박스 디자인 -->
                <div class="bg-white shadow overflow-hidden rounded-lg">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">No.</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">법인명</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">팀</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">과제명 (Project)</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">Leader</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">Kick-off</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">종류</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">등급</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">현재 상황</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">진척율</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">관리</th>
                                </tr>
                            </thead>
                            <tbody id="projects-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- JS로 동적 생성 -->
                                <tr><td colspan="11" class="px-4 py-4 text-center text-gray-500">데이터 로딩 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 탭 2: 법인별 요약 (대시보드) -->
            <div id="tab-summary" class="tab-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">법인별 요약 (대시보드)</h2>
                <!-- 박스 디자인 -->
                <div class="bg-white shadow overflow-hidden rounded-lg">
                    <div class="overflow-x-auto">
                        <!-- table-fixed와 w-full 추가 -->
                        <table class="min-w-full divide-y divide-gray-200 table-fixed w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">법인명</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">6σ (건)</th> <!-- 6σ (소문자)로 수정 -->
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">6S (건)</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">R&D (건)</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">AI (건)</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">총 과제 (건)</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">총 점수</th>
                                </tr>
                            </thead>
                            <tbody id="summary-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- JS로 동적 생성 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 탭 3: 벨트 요약 (인원) -->
            <div id="tab-belt" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">벨트 요약 (인원)</h2>
                    <button id="new-belt-btn" class="btn btn-primary">신규 인원 등록</button>
                </div>
                <!-- 박스 디자인 -->
                <div class="bg-white shadow overflow-hidden rounded-lg">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">법인명</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">MBB (명)</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">BB (명)</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">GB (명)</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">AI (명)</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">총 인원 (명)</th>
                                </tr>
                            </thead>
                            <tbody id="belt-summary-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- JS로 동적 생성 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 탭 4: 진척율 현황 대시보드 (신규) -->
            <div id="tab-progress" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">진척율 현황 대시보드</h2>
                    <!-- 필터 2개로 수정 -->
                    <div class="flex items-center space-x-2">
                        <label for="progress-corp-filter" class="text-sm font-medium text-gray-700">법인 필터:</label>
                        <select id="progress-corp-filter" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="전사">전사</option>
                            <option value="ATEC">ATEC</option>
                            <option value="ATEC SYSTEM">ATEC SYSTEM</option>
                            <option value="ATEC COMPUTER">ATEC COMPUTER</option>
                            <option value="ATEC MOBILITY">ATEC MOBILITY</option>
                            <option value="ATEC C&">ATEC C&</option>
                            <option value="ATEC auto">ATEC auto</option>
                        </select>
                        <!-- 과제 유형 필터 추가 -->
                        <label for="progress-type-filter" class="text-sm font-medium text-gray-700 ml-4">과제 유형:</label>
                        <select id="progress-type-filter" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="전체">전체</option>
                            <option value="6σ">6σ</option>
                            <option value="6S">6S</option>
                            <option value="R&D">R&D</option>
                            <option value="AI">AI</option>
                        </select>
                    </div>
                </div>
                
                <!-- 상단: 그래프 (박스 디자인) -->
                <div class="bg-white shadow rounded-lg p-6 mb-6">
                    <h3 id="progress-chart-title" class="text-lg font-medium text-gray-900 mb-4">월별 누적 평균 진척율 (%)</h3>
                    <div class="h-80">
                        <canvas id="progress-chart"></canvas>
                    </div>
                </div>
                
                <!-- 하단: 표 (박스 디자인) -->
                <div class="bg-white shadow overflow-hidden rounded-lg">
                    <h3 class="text-lg font-medium text-gray-900 p-6">월별 누적 평균 진척율 (유형별)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">월</th>
                                    <!-- (건) -> (%) 로 수정 -->
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">6S (%)</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">6σ (%)</th> <!-- 6σ (소문자)로 수정 -->
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">R&D (%)</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">AI (%)</th>
                                    <th class="px-4 py-3 text-left text-xs text-gray-500 uppercase tracking-wider">Total (%)</th>
                                </tr>
                            </thead>
                            <tbody id="progress-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- JS로 동적 생성 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- 2. 모달 영역 -->

    <!-- 관리자 로그인 모달 (value 제거됨) -->
    <div id="admin-login-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 hidden" onclick="closeModal('admin-login-modal', event)">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-medium">관리자 로그인</h3>
                <button onclick="closeModalFromButton('admin-login-modal')" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <form id="admin-login-form">
                <div class="p-6 space-y-4">
                    <div>
                        <label for="admin-id" class="block text-sm font-medium text-gray-700">아이디</label>
                        <input type="text" id="admin-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="admin-password" class="block text-sm font-medium text-gray-700">패스워드</label>
                        <input type="password" id="admin-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div id="admin-login-error" class="text-sm text-red-600"></div>
                </div>
                <div class="px-6 py-3 bg-gray-50 text-right">
                    <button type="button" onclick="closeModalFromButton('admin-login-modal')" class="btn btn-secondary mr-2">취소</button>
                    <button type="submit" class="btn btn-primary">로그인</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 담당자 로그인 모달 -->
    <div id="user-login-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 hidden" onclick="closeModal('user-login-modal', event)">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-medium">담당자 로그인</h3>
                <button onclick="closeModalFromButton('user-login-modal')" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <form id="user-login-form">
                <div class="p-6 space-y-4">
                    <div>
                        <label for="user-name-select" class="block text-sm font-medium text-gray-700">담당자명</label>
                        <select id="user-name-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="">담당자를 선택하세요</option>
                            <option value="김현진">김현진 (ATEC)</option>
                            <option value="이찬영">이찬영 (ATEC MOBILITY)</option>
                            <option value="정운수">정운수 (ATEC C&)</option>
                            <option value="이상영">이상영 (ATEC SYSTEM)</option>
                            <option value="김보람">김보람 (ATEC COMPUTER)</option>
                            <option value="강상순">강상순 (ATEC auto)</option>
                        </select>
                    </div>
                    <div id="user-login-error" class="text-sm text-red-600"></div>
                </div>
                <div class="px-6 py-3 bg-gray-50 text-right">
                    <button type="button" onclick="closeModalFromButton('user-login-modal')" class="btn btn-secondary mr-2">취소</button>
                    <button type="submit" class="btn btn-primary">로그인</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 과제 등록/수정 모달 -->
    <div id="project-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 hidden" onclick="closeModal('project-modal', event)">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl">
            <form id="project-form">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 id="project-modal-title" class="text-lg font-medium">신규 과제 등록</h3>
                    <button type="button" onclick="closeModalFromButton('project-modal')" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                
                <div class="p-6 overflow-y-auto" style="max-height: 80vh;">
                    <input type="hidden" id="project-id">
                    
                    <!-- 기본 정보 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="project-corporation" class="block text-sm font-medium text-gray-700">법인명</label>
                            <select id="project-corporation" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <option value="">선택</option>
                                <option value="ATEC">ATEC</option>
                                <option value="ATEC SYSTEM">ATEC SYSTEM</option>
                                <option value="ATEC COMPUTER">ATEC COMPUTER</option>
                                <option value="ATEC MOBILITY">ATEC MOBILITY</option>
                                <option value="ATEC C&">ATEC C&</option>
                                <option value="ATEC auto">ATEC auto</option>
                            </select>
                        </div>
                        <div>
                            <label for="project-department" class="block text-sm font-medium text-gray-700">사업부서</label>
                            <input type="text" id="project-department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="project-team" class="block text-sm font-medium text-gray-700">주관팀</label>
                            <input type="text" id="project-team" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="md:col-span-3">
                            <label for="project-name" class="block text-sm font-medium text-gray-700">과제명 (Project)</label>
                            <input type="text" id="project-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="project-leader" class="block text-sm font-medium text-gray-700">Leader</label>
                            <input type="text" id="project-leader" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label for="project-members" class="block text-sm font-medium text-gray-700">팀원 (쉼표로 구분)</label>
                            <input type="text" id="project-members" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="project-kickoff" class="block text-sm font-medium text-gray-700">Kick-off</label>
                            <input type="date" id="project-kickoff" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="project-type" class="block text-sm font-medium text-gray-700">과제 종류</label>
                            <select id="project-type" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <option value="">선택</option>
                                <option value="6σ">6σ</option>
                                <option value="6S">6S</option>
                                <option value="R&D">R&D</option>
                                <option value="AI">AI</option>
                            </select>
                        </div>
                        <div>
                            <label for="project-status" class="block text-sm font-medium text-gray-700">현재 상황</label>
                            <select id="project-status" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <option value="미실행">미실행</option>
                                <option value="정의">정의 (D)</option>
                                <option value="측정">측정 (M)</option>
                                <option value="분석">분석 (A)</option>
                                <option value="개선">개선 (I)</option>
                                <option value="관리">관리 (C)</option>
                                <option value="완료">완료</option>
                            </select>
                        </div>
                    </div>

                    <!-- DMAIC 진척도 -->
                    <div class="border-t pt-4 mb-4">
                        <h4 class="text-md font-medium text-gray-800 mb-3">DMAIC 진척도 (0 ~ 1.0)</h4>
                        <div class="grid grid-cols-5 gap-3">
                            <div>
                                <label for="dmaic-d" class="block text-sm font-medium text-gray-700">Define (정의)</label>
                                <input type="number" id="dmaic-d" min="0" max="1" step="0.1" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="dmaic-m" class="block text-sm font-medium text-gray-700">Measure (측정)</label>
                                <input type="number" id="dmaic-m" min="0" max="1" step="0.1" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="dmaic-a" class="block text-sm font-medium text-gray-700">Analyze (분석)</label>
                                <input type="number" id="dmaic-a" min="0" max="1" step="0.1" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="dmaic-i" class="block text-sm font-medium text-gray-700">Improve (개선)</label>
                                <input type="number" id="dmaic-i" min="0" max="1" step="0.1" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="dmaic-c" class="block text-sm font-medium text-gray-700">Control (관리)</label>
                                <input type="number" id="dmaic-c" min="0" max="1" step="0.1" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- 과제 타당성 평가 (동적 표시) -->
                    <div id="validity-score-section" class="border-t pt-4 hidden">
                        <h4 class="text-md font-medium text-gray-800 mb-3">과제 타당성 평가</h4>
                        <p class="text-sm text-gray-500 mb-3">모든 과제 유형에 적용됩니다. 점수에 따라 등급(A-D)이 자동 부여됩니다.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="score-potential" class="block text-sm font-medium text-gray-700">잠재영향도 (1/3/9)</label>
                                <select id="score-potential" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                    <option value="1">1점 (낮음)</option>
                                    <option value="3">3점 (중간)</option>
                                    <option value="9">9점 (높음)</option>
                                </select>
                            </div>
                            <div>
                                <label for="score-strategy" class="block text-sm font-medium text-gray-700">전략연계성 (1/6/18)</label>
                                <select id="score-strategy" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                    <option value="1">1점 (낮음)</option>
                                    <option value="6">6점 (중간)</option>
                                    <option value="18">18점 (높음)</option>
                                </select>
                            </div>
                            <div>
                                <label for="score-effect" class="block text-sm font-medium text-gray-700">기대효과 (1/3/9)</label>
                                <select id="score-effect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                    <option value="1">1점 (낮음)</option>
                                    <option value="3">3점 (중간)</option>
                                    <option value="9">9점 (높음)</option>
                                </select>
                            </div>
                            <div>
                                <label for="score-ripple" class="block text-sm font-medium text-gray-700">파급효과 (1/3/9)</label>
                                <select id="score-ripple" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                    <option value="1">1점 (낮음)</option>
                                    <option value="3">3점 (중간)</option>
                                    <option value="9">9점 (높음)</option>
                                </select>
                            </div>
                            <div>
                                <label for="score-feasibility" class="block text-sm font-medium text-gray-700">실현용이성 (1/3/9)</label>
                                <select id="score-feasibility" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                    <option value="1">1점 (낮음)</option>
                                    <option value="3">3점 (중간)</option>
                                    <option value="9">9점 (높음)</option>
                                </select>
                            </div>
                            <div>
                                <label for="score-urgency" class="block text-sm font-medium text-gray-700">시급성 (1/3/9)</label>
                                <select id="score-urgency" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                    <option value="1">1점 (낮음)</option>
                                    <option value="3">3점 (중간)</option>
                                    <option value="9">9점 (높음)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="px-6 py-3 bg-gray-50 text-right">
                    <button type="button" onclick="closeModalFromButton('project-modal')" class="btn btn-secondary mr-2">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 벨트 인원 등록 모달 -->
    <div id="belt-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 hidden" onclick="closeModal('belt-modal', event)">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md">
            <form id="belt-form">
                <input type="hidden" id="belt-id">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-lg font-medium">신규 인원 등록</h3>
                    <button type="button" onclick="closeModalFromButton('belt-modal')" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="belt-corporation" class="block text-sm font-medium text-gray-700">법인명</label>
                        <select id="belt-corporation" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="">선택</option>
                            <option value="ATEC">ATEC</option>
                            <option value="ATEC SYSTEM">ATEC SYSTEM</option>
                            <option value="ATEC COMPUTER">ATEC COMPUTER</option>
                            <option value="ATEC MOBILITY">ATEC MOBILITY</option>
                            <option value="ATEC C&">ATEC C&</option>
                            <option value="ATEC auto">ATEC auto</option>
                        </select>
                    </div>
                    <div>
                        <label for="belt-name" class="block text-sm font-medium text-gray-700">성명</label>
                        <input type="text" id="belt-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="belt-grade" class="block text-sm font-medium text-gray-700">벨트 등급</label>
                        <select id="belt-grade" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="">선택</option>
                            <option value="MBB">MBB</option>
                            <option value="BB">BB</option>
                            <option value="GB">GB</option>
                            <option value="AI">AI</option>
                        </select>
                    </div>
                </div>
                <div class="px-6 py-3 bg-gray-50 text-right">
                    <button type="button" onclick="closeModalFromButton('belt-modal')" class="btn btn-secondary mr-2">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 커스텀 알림 모달 -->
    <div id="alert-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 hidden" onclick="closeModal('alert-modal', event)">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6">
                <h3 class="text-lg font-medium mb-4">알림</h3>
                <p id="alert-message" class="text-sm text-gray-600 mb-6">메시지</p>
                <div class="text-right">
                    <button onclick="closeModalFromButton('alert-modal')" class="btn btn-primary">확인</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase/앱 로직 -->
    <script type="module">
        // Firebase SDK v11.6.1
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            writeBatch,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 전역 변수 ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let db, auth, userId;
        let unsubscribeProjects = null;
        let unsubscribeBelts = null;
        let localProjectsCache = []; // 로컬 캐시 (필터링된 데이터)
        let localBeltsCache = []; // 로컬 캐시 (필터링된 데이터)
        let progressChartInstance = null; // 차트 인스턴스

        // 담당자-법인 매핑
        const userCorporationMap = {
            '김현진': 'ATEC',
            '이찬영': 'ATEC MOBILITY',
            '정운수': 'ATEC C&',
            '이상영': 'ATEC SYSTEM',
            '김보람': 'ATEC COMPUTER',
            '강상순': 'ATEC auto'
        };


        // --- 0. 로그인 및 권한 ---
        let currentUserRole = null; // 'admin' 또는 'user'
        let currentUserCorporation = null; // 'admin'은 null, 'user'는 법인명

        // 메인 앱 시작
        function startMainApp() {
            // 1. 로그인 화면 숨기기
            document.getElementById('role-selection-overlay').style.display = 'none';
            
            // 2. 메인 앱 보이기
            document.getElementById('main-app-container').classList.remove('hidden');
            
            // 3. Firebase 초기화 시작 (로그인 후에 시작)
            initializeFirebase();
        }

        // 관리자 로그인 처리
        function handleAdminLogin(e) {
            e.preventDefault();
            const id = document.getElementById('admin-id').value;
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('admin-login-error');

            // 하드코딩된 아이디와 패스워드 검증
            if (id === 'admin' && password === '$atec@1993$') {
                errorEl.textContent = '';
                closeModalFromButton('admin-login-modal');
                
                currentUserRole = 'admin';
                currentUserCorporation = null;
                document.getElementById('app-subtitle').textContent += " (관리자 모드)";
                
                startMainApp();
            } else {
                errorEl.textContent = '아이디 또는 패스워드가 잘못되었습니다.';
            }
        }

        // 담당자 로그인 처리
        function handleUserLogin(e) {
            e.preventDefault();
            const userName = document.getElementById('user-name-select').value;
            const errorEl = document.getElementById('user-login-error');

            if (userName && userCorporationMap[userName]) {
                errorEl.textContent = '';
                closeModalFromButton('user-login-modal');
                
                currentUserRole = 'user';
                currentUserCorporation = userCorporationMap[userName];
                document.getElementById('app-subtitle').textContent += ` (담당자: ${userName} - ${currentUserCorporation})`;
                
                startMainApp();
            } else {
                errorEl.textContent = '유효한 담당자를 선택하세요.';
            }
        }

        // 관리자 UI 토글 (시뮬레이션 버튼)
        function toggleAdminUI() {
            const adminControls = document.getElementById('admin-only-controls');
            if (!adminControls) return;

            if (currentUserRole === 'admin') {
                adminControls.classList.remove('hidden');
            } else {
                adminControls.classList.add('hidden');
            }
        }
        
        // --- Firestore 경로 ---
        const getProjectsCol = () => collection(db, `/artifacts/${appId}/public/data/projects`);
        const getBeltsCol = () => collection(db, `/artifacts/${appId}/public/data/belts`);


        // --- Firebase 초기화 및 인증 ---
        async function initializeFirebase() {
            try {
                if (!firebaseConfig.apiKey) {
                    // Try to get config from global variable if defined (for deployment)
                    if (window.firebaseConfig) {
                        Object.assign(firebaseConfig, window.firebaseConfig);
                    } else {
                        throw new Error("Firebase config is missing or invalid.");
                    }
                }
                
                let app;
                // v8 호환성 대신 v9+ 모듈식 사용
                if (getApps().length === 0) {
                    app = initializeApp(firebaseConfig);
                } else {
                    app = getApp(); 
                }

                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); 

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Firebase Auth: User is signed in.", user.uid);
                        userId = user.uid;
                    } else {
                        console.log("Firebase Auth: User is signed out. Attempting sign-in...");
                        await signIn();
                    }
                    
                    if (!unsubscribeProjects) { 
                        setupListeners();
                    }
                });

                // 초기 로그인 시도
                if (!auth.currentUser) {
                    await signIn();
                } else {
                    userId = auth.currentUser.uid;
                    if (!unsubscribeProjects) {
                        setupListeners();
                    }
                }

            } catch (error)
            {
                console.error("Firebase initialization error:", error);
                document.body.innerHTML = `<div class="p-8 text-red-600">Firebase 초기화에 실패했습니다. 관리자에게 문의하세요. 오류: ${error.message}</div>`;
            }
        }

        async function signIn() {
            try {
                if (typeof __initial_auth_token !== 'undefined') {
                    console.log("Attempting sign in with custom token...");
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    console.log("Attempting sign in anonymously...");
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase sign-in error:", error);
            }
        }


        // --- 데이터 리스너 설정 (권한별 필터링 적용) ---
        function setupListeners() {
            if (!db || !auth.currentUser) {
                console.log("Firestore or Auth not ready, delaying listeners.");
                return;
            }

            console.log(`Setting up Firestore listeners for role: ${currentUserRole}, corp: ${currentUserCorporation}`);
            
            document.getElementById('app-id-display').textContent = appId;
            
            toggleAdminUI(); // 시뮬레이션 버튼 숨김/표시
            
            // 담당자 모드일 경우 필터 드롭다운을 해당 법인으로 고정
            if (currentUserRole === 'user') {
                const progressFilter = document.getElementById('progress-corp-filter');
                progressFilter.value = currentUserCorporation;
                progressFilter.disabled = true;
            }

            // 1. 과제 쿼리 (권한별 분기)
            let projectsQuery;
            if (currentUserRole === 'admin') {
                projectsQuery = getProjectsCol(); // 관리자: 전체 조회
            } else {
                projectsQuery = query(getProjectsCol(), where("corporation", "==", currentUserCorporation)); // 담당자: 법인별 필터링
            }
            
            if (unsubscribeProjects) unsubscribeProjects(); 
            unsubscribeProjects = onSnapshot(projectsQuery, (snapshot) => {
                console.log(`Projects snapshot received: ${snapshot.size} docs`);
                localProjectsCache = []; // 로컬 캐시 업데이트
                snapshot.forEach(doc => {
                    localProjectsCache.push({ id: doc.id, ...doc.data() });
                });
                localProjectsCache.sort((a, b) => new Date(a.kickoff) - new Date(b.kickoff));
                
                // 모든 대시보드 업데이트
                loadProjectsTable(localProjectsCache);
                loadSummaryDashboard(localProjectsCache); 
                loadProgressDashboard(); // 신규 대시보드 로드
            }, (error) => {
                console.error("Error listening to projects:", error);
            });

            // 2. 벨트 쿼리 (권한별 분기)
            let beltsQuery;
            if (currentUserRole === 'admin') {
                beltsQuery = getBeltsCol(); // 관리자: 전체 조회
            } else {
                beltsQuery = query(getBeltsCol(), where("corporation", "==", currentUserCorporation)); // 담당자: 법인별 필터링
            }

            if (unsubscribeBelts) unsubscribeBelts(); 
            unsubscribeBelts = onSnapshot(beltsQuery, (snapshot) => {
                console.log(`Belts snapshot received: ${snapshot.size} docs`);
                localBeltsCache = []; // 로컬 캐시 업데이트
                snapshot.forEach(doc => {
                    localBeltsCache.push({ id: doc.id, ...doc.data() });
                });
                
                loadBeltSummary(localBeltsCache); 
            }, (error) => {
                console.error("Error listening to belts:", error);
            });
        }


        // --- 1. 과제 운영 (프로젝트) ---

        // 과제 테이블 로드
        function loadProjectsTable(projects) {
            const tableBody = document.getElementById('projects-table-body');
            if (projects.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="11" class="px-4 py-4 text-center text-gray-500">등록된 과제가 없습니다.</td></tr>`;
                return;
            }

            tableBody.innerHTML = ''; 
            
            projects.forEach((project, index) => {
                const row = document.createElement('tr');
                
                const dmaicValues = [
                    parseFloat(project.dmaic_d || 0),
                    parseFloat(project.dmaic_m || 0),
                    parseFloat(project.dmaic_a || 0),
                    parseFloat(project.dmaic_i || 0),
                    parseFloat(project.dmaic_c || 0)
                ];
                const progress = dmaicValues.reduce((sum, val) => sum + val, 0) / 5;
                const progressPercent = (progress * 100).toFixed(0);

                const progressBarHTML = `
                    <div class="relative w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progressPercent}%"></div>
                    </div>
                    <div class="text-xs text-right text-gray-600 mt-1">${progressPercent}%</div>
                `;
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">${index + 1}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${project.corporation || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${project.team || 'N/A'}</td>
                    <td class="px-4 py-3">${project.name || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${project.leader || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${project.kickoff || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${project.type || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap font-semibold">${project.grade || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${project.status || 'N/A'}</td>
                    <td class="px-4 py-3">${progressBarHTML}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <button class="text-blue-600 hover:text-blue-800" data-id="${project.id}">수정</button>
                        <button class="text-red-600 hover:text-red-800 ml-2" data-id="${project.id}">삭제</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            tableBody.querySelectorAll('button[data-id]').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    if (e.target.textContent === '수정') {
                        await openEditProjectModal(id);
                    } else if (e.target.textContent === '삭제') {
                        await deleteProject(id);
                    }
                });
            });
        }

        // 과제 저장 (신규/수정) - DMAIC 계층 로직 적용
        async function saveProject(e) {
            e.preventDefault();
            const id = document.getElementById('project-id').value;
            
            let status = document.getElementById('project-status').value;
            const dmaic_d_val = parseFloat(document.getElementById('dmaic-d').value || 0);
            const dmaic_m_val = parseFloat(document.getElementById('dmaic-m').value || 0);
            const dmaic_a_val = parseFloat(document.getElementById('dmaic-a').value || 0);
            const dmaic_i_val = parseFloat(document.getElementById('dmaic-i').value || 0);
            const dmaic_c_val = parseFloat(document.getElementById('dmaic-c').value || 0);

            let alertMessage = "";

            // 1. '완료' 유효성 검사 (저장 차단)
            if (status === '완료') {
                if (dmaic_d_val !== 1.0 || dmaic_m_val !== 1.0 || dmaic_a_val !== 1.0 || dmaic_i_val !== 1.0 || dmaic_c_val !== 1.0) {
                    showAlertModal("'완료' 상태로 저장하려면 모든 DMAIC 단계가 100% (1.0)여야 합니다. (저장 차단됨)");
                    return;
                }
            } 
            // 2. '관리' 유효성 검사 (자동 조정)
            else if (status === '관리') {
                if (dmaic_i_val !== 1.0) {
                    alertMessage = "'관리' 단계는 '개선(I)'이 100% 완료되어야 합니다. '현재 상황'을 '개선'으로 자동 조정합니다.";
                    status = '개선';
                }
            } 
            // 3. '개선' 유효성 검사 (자동 조정)
            else if (status === '개선') {
                if (dmaic_a_val !== 1.0) {
                    alertMessage = "'개선' 단계는 '분석(A)'이 100% 완료되어야 합니다. '현재 상황'을 '분석'으로 자동 조정합니다.";
                    status = '분석';
                }
            } 
            // 4. '분석' 유효성 검사 (자동 조정)
            else if (status === '분석') {
                if (dmaic_m_val !== 1.0) {
                    alertMessage = "'분석' 단계는 '측정(M)'이 100% 완료되어야 합니다. '현재 상황'을 '측정'으로 자동 조정합니다.";
                    status = '측정';
                }
            } 
            // 5. '측정' 유효성 검사 (자동 조정)
            else if (status === '측정') {
                if (dmaic_d_val !== 1.0) {
                    alertMessage = "'측정' 단계는 '정의(D)'가 100% 완료되어야 합니다. '현재 상황'을 '정의'로 자동 조정합니다.";
                    status = '정의';
                }
            }

            if (alertMessage) {
                showAlertModal(alertMessage);
                document.getElementById('project-status').value = status;
            }
            
            const projectType = document.getElementById('project-type').value;
            let grade = null;

            const scores = [
                parseInt(document.getElementById('score-potential').value),
                parseInt(document.getElementById('score-strategy').value),
                parseInt(document.getElementById('score-effect').value),
                parseInt(document.getElementById('score-ripple').value),
                parseInt(document.getElementById('score-feasibility').value),
                parseInt(document.getElementById('score-urgency').value)
            ];
            const totalScore = scores.reduce((sum, val) => sum + val, 0);
            grade = calculateGrade(totalScore);

            const projectData = {
                corporation: document.getElementById('project-corporation').value,
                department: document.getElementById('project-department').value,
                team: document.getElementById('project-team').value,
                name: document.getElementById('project-name').value,
                leader: document.getElementById('project-leader').value,
                members: document.getElementById('project-members').value,
                kickoff: document.getElementById('project-kickoff').value,
                type: projectType,
                status: status,
                dmaic_d: dmaic_d_val,
                dmaic_m: dmaic_m_val,
                dmaic_a: dmaic_a_val,
                dmaic_i: dmaic_i_val,
                dmaic_c: dmaic_c_val,
                score_potential: scores[0],
                score_strategy: scores[1],
                score_effect: scores[2],
                score_ripple: scores[3],
                score_feasibility: scores[4],
                score_urgency: scores[5],
                score_total: totalScore,
                grade: grade, 
            };
            
            // 담당자가 자기 법인이 아닌 과제를 등록/수정하려 할 때 방지
            if (currentUserRole === 'user' && projectData.corporation !== currentUserCorporation) {
                showAlertModal(`담당자 모드에서는 소속 법인(${currentUserCorporation})의 과제만 등록/수정할 수 있습니다.`);
                document.getElementById('project-corporation').value = currentUserCorporation;
                return;
            }


            try {
                if (id) {
                    const docRef = doc(db, getProjectsCol().path, id);
                    await updateDoc(docRef, projectData);
                } else {
                    await addDoc(getProjectsCol(), projectData);
                }
                closeModalFromButton('project-modal');
            } catch (error) {
                console.error("Error saving project:", error);
                showAlertModal(`저장 중 오류가 발생했습니다: ${error.message}`);
            }
        }


        // 과제 삭제
        async function deleteProject(id) {
            try {
                const docRef = doc(db, getProjectsCol().path, id);
                await deleteDoc(docRef);
            } catch (error) {
                console.error("Error deleting project:", error);
                showAlertModal(`삭제 중 오류가 발생했습니다: ${error.message}`);
            }
        }

        // 신규 과제 모달 열기
        document.getElementById('new-project-btn').addEventListener('click', () => {
            document.getElementById('project-form').reset(); 
            document.getElementById('project-id').value = '';
            document.getElementById('project-modal-title').textContent = '신규 과제 등록';
            
            // 담당자 모드일 경우 법인명 자동 선택 및 고정
            if (currentUserRole === 'user') {
                document.getElementById('project-corporation').value = currentUserCorporation;
                document.getElementById('project-corporation').disabled = true;
            } else {
                document.getElementById('project-corporation').disabled = false;
            }

            toggleValiditySection(); 
            openModal('project-modal');
        });

        // 과제 수정 모달 열기
        async function openEditProjectModal(id) {
            try {
                const docRef = doc(db, getProjectsCol().path, id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('project-id').value = id;
                    document.getElementById('project-modal-title').textContent = '과제 수정';
                    
                    document.getElementById('project-corporation').value = data.corporation || '';
                    document.getElementById('project-department').value = data.department || '';
                    document.getElementById('project-team').value = data.team || '';
                    document.getElementById('project-name').value = data.name || '';
                    document.getElementById('project-leader').value = data.leader || '';
                    document.getElementById('project-members').value = data.members || '';
                    document.getElementById('project-kickoff').value = data.kickoff || '';
                    document.getElementById('project-type').value = data.type || '';
                    document.getElementById('project-status').value = data.status || '미실행';

                    document.getElementById('dmaic-d').value = data.dmaic_d || 0;
                    document.getElementById('dmaic-m').value = data.dmaic_m || 0;
                    document.getElementById('dmaic-a').value = data.dmaic_a || 0;
                    document.getElementById('dmaic-i').value = data.dmaic_i || 0;
                    document.getElementById('dmaic-c').value = data.dmaic_c || 0;

                    document.getElementById('score-potential').value = data.score_potential || 1;
                    document.getElementById('score-strategy').value = data.score_strategy || 1;
                    document.getElementById('score-effect').value = data.score_effect || 1;
                    document.getElementById('score-ripple').value = data.score_ripple || 1;
                    document.getElementById('score-feasibility').value = data.score_feasibility || 1;
                    document.getElementById('score-urgency').value = data.score_urgency || 1;
                    
                    // 담당자 모드일 경우 법인명 고정
                    if (currentUserRole === 'user') {
                        document.getElementById('project-corporation').disabled = true;
                    } else {
                        document.getElementById('project-corporation').disabled = false;
                    }
                    
                    toggleValiditySection(); 
                    openModal('project-modal');
                }
            } catch (error) {
                console.error("Error fetching project for edit:", error);
                showAlertModal(`데이터를 불러오는 중 오류가 발생했습니다: ${error.message}`);
            }
        }

        // 과제 종류(type) 선택 시 타당성 평가 섹션 토글
        document.getElementById('project-type').addEventListener('change', toggleValiditySection);

        function toggleValiditySection() {
            const projectType = document.getElementById('project-type').value;
            const section = document.getElementById('validity-score-section');
            if (projectType) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        }

        // 과제 등급 계산
        function calculateGrade(score) {
            if (score >= 51) return 'A';
            if (score >= 45) return 'B';
            if (score >= 39) return 'C';
            return 'D';
        }


        // --- 2. 법인별 요약 (대시보드) ---

        // 집계 로직 (권한별 필터링 적용)
        function getProjectSummaryStats(projects) {
            const allCorporations = ["ATEC", "ATEC SYSTEM", "ATEC COMPUTER", "ATEC MOBILITY", "ATEC C&", "ATEC auto"];
            // 관리자면 전체 법인, 담당자면 자기 법인만
            const corporations = (currentUserRole === 'admin') ? allCorporations : [currentUserCorporation];

            let stats = {};
            let totals = { "6σ": 0, "6S": 0, "R&D": 0, "AI": 0, total: 0, score: 0 };

            corporations.forEach(corp => {
                stats[corp] = { "6σ": 0, "6S": 0, "R&D": 0, "AI": 0, total: 0, score: 0 };
            });

            // 'projects'는 이미 리스너 레벨에서 필터링됨
            projects.forEach(p => {
                if (stats[p.corporation]) {
                    let score = 0;
                    switch(p.type) {
                        case '6σ':
                            stats[p.corporation]["6σ"]++;
                            score = 3;
                            break;
                        case '6S':
                            stats[p.corporation]["6S"]++;
                            score = 1;
                            break;
                        case 'R&D':
                            stats[p.corporation]["R&D"]++;
                            score = 3;
                            break;
                        case 'AI':
                            stats[p.corporation]["AI"]++;
                            score = 3; 
                            break;
                    }
                    stats[p.corporation].total++;
                    stats[p.corporation].score += score;
                }
            });

            corporations.forEach(corp => {
                const data = stats[corp];
                totals["6σ"] += data["6σ"];
                totals["6S"] += data["6S"];
                totals["R&D"] += data["R&D"];
                totals["AI"] += data["AI"];
                totals.total += data.total;
                totals.score += data.score;
            });

            return { stats, totals, corporations };
        }

        function loadSummaryDashboard(projects) {
            const tableBody = document.getElementById('summary-table-body');
            const { stats, totals, corporations } = getProjectSummaryStats(projects);

            tableBody.innerHTML = ''; 
            
            corporations.forEach(corp => {
                const data = stats[corp];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-left font-semibold">${corp}</td>
                    <td class="px-4 py-3">${data["6σ"]}</td>
                    <td class="px-4 py-3">${data["6S"]}</td>
                    <td class="px-4 py-3">${data["R&D"]}</td>
                    <td class="px-4 py-3">${data["AI"]}</td>
                    <td class="px-4 py-3 font-semibold">${data.total}</td>
                    <td class="px-4 py-3 font-semibold text-blue-700">${data.score}</td>
                `;
                tableBody.appendChild(row);
            });

            // 합계 행 (td에 font-bold 추가)
            const totalRow = document.createElement('tr');
            totalRow.className = "bg-gray-100 text-gray-900"; 
            totalRow.innerHTML = `
                <td class="px-4 py-3 text-left font-bold">합계</td>
                <td class="px-4 py-3 font-bold">${totals["6σ"]}</td>
                <td class="px-4 py-3 font-bold">${totals["6S"]}</td>
                <td class="px-4 py-3 font-bold">${totals["R&D"]}</td>
                <td class="px-4 py-3 font-bold">${totals["AI"]}</td>
                <td class="px-4 py-3 font-bold">${totals.total}</td>
                <td class="px-4 py-3 font-bold text-blue-900">${totals.score}</td>
            `;
            tableBody.appendChild(totalRow);
        }


        // --- 3. 벨트 요약 (인원) ---

        // 집계 로직 (권한별 필터링 적용)
        function getBeltSummaryStats(belts) {
            const allCorporations = ["ATEC", "ATEC SYSTEM", "ATEC COMPUTER", "ATEC MOBILITY", "ATEC C&", "ATEC auto"];
            // 관리자면 전체 법인, 담당자면 자기 법인만
            const corporations = (currentUserRole === 'admin') ? allCorporations : [currentUserCorporation];
            
            let stats = {};
            let totals = { MBB: 0, BB: 0, GB: 0, AI: 0, total: 0 };

            corporations.forEach(corp => {
                stats[corp] = { MBB: 0, BB: 0, GB: 0, AI: 0, total: 0 };
            });

            // 'belts'는 이미 리스너 레벨에서 필터링됨
            belts.forEach(p => {
                if (stats[p.corporation]) {
                    if (stats[p.corporation][p.grade] !== undefined) {
                        stats[p.corporation][p.grade]++;
                        stats[p.corporation].total++;
                    }
                }
            });

            corporations.forEach(corp => {
                const data = stats[corp];
                totals.MBB += data.MBB;
                totals.BB += data.BB;
                totals.GB += data.GB;
                totals.AI += data.AI;
                totals.total += data.total;
            });

            return { stats, totals, corporations };
        }

        function loadBeltSummary(belts) {
            const tableBody = document.getElementById('belt-summary-table-body');
            const { stats, totals, corporations } = getBeltSummaryStats(belts);

            tableBody.innerHTML = ''; 
            
            corporations.forEach(corp => {
                const data = stats[corp];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-left font-semibold">${corp}</td>
                    <td class="px-4 py-3">${data.MBB}</td>
                    <td class="px-4 py-3">${data.BB}</td>
                    <td class="px-4 py-3">${data.GB}</td>
                    <td class="px-4 py-3">${data.AI}</td>
                    <td class="px-4 py-3 font-semibold text-blue-700">${data.total}</td>
                `;
                tableBody.appendChild(row);
            });

            // 합계 행 (td에 font-bold 추가)
            const totalRow = document.createElement('tr');
            totalRow.className = "bg-gray-100 text-gray-900"; 
            totalRow.innerHTML = `
                <td class="px-4 py-3 text-left font-bold">합계</td>
                <td class="px-4 py-3 font-bold">${totals.MBB}</td>
                <td class="px-4 py-3 font-bold">${totals.BB}</td>
                <td class="px-4 py-3 font-bold">${totals.GB}</td>
                <td class="px-4 py-3 font-bold">${totals.AI}</td>
                <td class="px-4 py-3 font-bold text-blue-900">${totals.total}</td>
            `;
            tableBody.appendChild(totalRow);
        }

        // 신규 인원 등록 모달 열기
        document.getElementById('new-belt-btn').addEventListener('click', () => {
            document.getElementById('belt-form').reset();
            document.getElementById('belt-id').value = '';
            
            // 담당자 모드일 경우 법인명 자동 선택 및 고정
            if (currentUserRole === 'user') {
                document.getElementById('belt-corporation').value = currentUserCorporation;
                document.getElementById('belt-corporation').disabled = true;
            } else {
                document.getElementById('belt-corporation').disabled = false;
            }
            
            openModal('belt-modal');
        });

        // 벨트 인원 저장
        async function saveBelt(e) {
            e.preventDefault();
            const id = document.getElementById('belt-id').value;
            const beltData = {
                corporation: document.getElementById('belt-corporation').value,
                name: document.getElementById('belt-name').value,
                grade: document.getElementById('belt-grade').value,
            };
            
            // 담당자가 자기 법인이 아닌 인원을 등록/수정하려 할 때 방지
            if (currentUserRole === 'user' && beltData.corporation !== currentUserCorporation) {
                showAlertModal(`담당자 모드에서는 소속 법인(${currentUserCorporation})의 인원만 등록/수정할 수 있습니다.`);
                document.getElementById('belt-corporation').value = currentUserCorporation;
                return;
            }

            try {
                if (id) {
                    const docRef = doc(db, getBeltsCol().path, id);
                    await updateDoc(docRef, beltData);
                } else {
                    await addDoc(getBeltsCol(), beltData);
                }
                closeModalFromButton('belt-modal');
            } catch (error) {
                console.error("Error saving belt person:", error);
                showAlertModal(`저장 중 오류가 발생했습니다: ${error.message}`);
            }
        }

        // --- 4. 진척율 현황 대시보드 (로직 수정) ---
        
        /**
         * '누적 평균 진척율' 계산
         * 1. 법인 필터로 먼저 거른다.
         * 2. 1월~12월을 순회한다.
         * 3. 각 월(month)마다, 해당 월 이전에 Kick-off한 모든 과제를 찾는다.
         * 4. 이 과제들의 평균 진척율을 계산한다 (유형별, 전체).
         * 5. 그래프는 '과제 유형 필터'를 추가로 적용하여 그린다.
         */
        function getProgressDashboardStats() {
            const corpFilter = document.getElementById('progress-corp-filter').value;
            const typeFilter = document.getElementById('progress-type-filter').value; 

            // 1. 법인 필터로 먼저 거른다 (역할 필터는 localProjectsCache에 이미 적용됨)
            const corpFilteredProjects = localProjectsCache.filter(p => {
                return (corpFilter === '전사' || p.corporation === corpFilter) && p.kickoff;
            });

            const monthlyStats = Array(12).fill(null).map(() => ({
                '6S': { sum: 0, count: 0, avg: 0 },
                '6σ': { sum: 0, count: 0, avg: 0 },
                'R&D': { sum: 0, count: 0, avg: 0 },
                'AI': { sum: 0, count: 0, avg: 0 },
                'Total': { sum: 0, count: 0, avg: 0 }
            }));

            const currentYear = new Date().getFullYear(); // 가정된 년도 (예: 2025)

            for (let month = 0; month < 12; month++) { // 0 = 1월
                // 해당 월의 말일 (예: 1월 31일)
                const currentMonthEndDate = new Date(currentYear, month + 1, 0); 

                // 2. 해당 월 이전에 Kick-off한 모든 과제를 찾는다.
                const projectsActiveThisMonth = corpFilteredProjects.filter(p => {
                    try {
                        return new Date(p.kickoff) <= currentMonthEndDate;
                    } catch (e) { return false; }
                });

                if (projectsActiveThisMonth.length > 0) {
                    projectsActiveThisMonth.forEach(p => {
                        const dmaicValues = [
                            parseFloat(p.dmaic_d || 0), parseFloat(p.dmaic_m || 0),
                            parseFloat(p.dmaic_a || 0), parseFloat(p.dmaic_i || 0),
                            parseFloat(p.dmaic_c || 0)
                        ];
                        const progress = dmaicValues.reduce((sum, val) => sum + val, 0) / 5; // 0 to 1

                        if (p.type === '6S') {
                            monthlyStats[month]['6S'].sum += progress;
                            monthlyStats[month]['6S'].count++;
                        } else if (p.type === '6σ') {
                            monthlyStats[month]['6σ'].sum += progress;
                            monthlyStats[month]['6σ'].count++;
                        } else if (p.type === 'R&D') {
                            monthlyStats[month]['R&D'].sum += progress;
                            monthlyStats[month]['R&D'].count++;
                        } else if (p.type === 'AI') {
                            monthlyStats[month]['AI'].sum += progress;
                            monthlyStats[month]['AI'].count++;
                        }
                    });

                    // 3. 해당 월의 평균 진척율 계산
                    ['6S', '6σ', 'R&D', 'AI'].forEach(type => {
                        if (monthlyStats[month][type].count > 0) {
                            monthlyStats[month][type].avg = (monthlyStats[month][type].sum / monthlyStats[month][type].count) * 100;
                        }
                        monthlyStats[month]['Total'].sum += monthlyStats[month][type].sum;
                        monthlyStats[month]['Total'].count += monthlyStats[month][type].count;
                    });
                    
                    if (monthlyStats[month]['Total'].count > 0) {
                        monthlyStats[month]['Total'].avg = (monthlyStats[month]['Total'].sum / monthlyStats[month]['Total'].count) * 100;
                    }
                }
            }
            
            // 4. 그래프용 데이터 준비 (과제 유형 필터 적용)
            const graphData = [];
            for (let month = 0; month < 12; month++) {
                if (typeFilter === '전체') {
                    graphData.push(monthlyStats[month]['Total'].avg);
                } else if (monthlyStats[month][typeFilter]) { // 6σ, 6S, R&D, AI
                    graphData.push(monthlyStats[month][typeFilter].avg);
                } else {
                    graphData.push(0); // 혹시 모를 오류 방지
                }
            }
            
            return { tableStats: monthlyStats, graphData }; // 표(전체 유형)와 그래프(필터링된 유형) 데이터 반환
        }
        
        function loadProgressDashboard() {
            if (!Chart || !document.getElementById('progress-chart')) return; 
            
            const { tableStats, graphData } = getProgressDashboardStats();
            
            // 1. 상단 그래프 (Chart.js)
            const ctx = document.getElementById('progress-chart').getContext('2d');
            const labels = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
            
            // 그래프 제목 동적 변경
            const typeFilter = document.getElementById('progress-type-filter').value;
            const corpFilter = document.getElementById('progress-corp-filter').value;
            let graphLabel = (typeFilter === '전체' ? '전체' : typeFilter) + ' 과제 누적 평균 진척율';
            if (corpFilter !== '전사') {
                graphLabel = `${corpFilter} ` + graphLabel;
            }
            document.getElementById('progress-chart-title').textContent = graphLabel;

            if (progressChartInstance) {
                progressChartInstance.destroy();
            }
            
            progressChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: graphLabel, // Dynamic label
                        data: graphData, // 새로운 누적 % 데이터
                        borderColor: 'rgb(37, 99, 235)', // blue-600
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100, // Y축은 0-100%
                            ticks: {
                                stepSize: 10,
                                callback: function(value) {
                                    return value + '%'; // Y축에 % 표시
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // 요청대로 범례 숨김
                        }
                    }
                }
            });

            // 2. 하단 표 (누적 %로 수정)
            const tableBody = document.getElementById('progress-table-body');
            tableBody.innerHTML = '';
            
            tableStats.forEach((monthData, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap font-semibold">${index + 1}월</td>
                    <td class="px-4 py-3">${monthData['6S'].avg.toFixed(1)}%</td>
                    <td class="px-4 py-3">${monthData['6σ'].avg.toFixed(1)}%</td>
                    <td class="px-4 py-3">${monthData['R&D'].avg.toFixed(1)}%</td>
                    <td class="px-4 py-3">${monthData['AI'].avg.toFixed(1)}%</td>
                    <td class="px-4 py-3 font-semibold text-blue-700">${monthData['Total'].avg.toFixed(1)}%</td>
                `;
                tableBody.appendChild(row);
            });
        }


        // --- 5. CSV 일괄 업로드/다운로드 ---

        // CSV 다운로드 범용 헬퍼
        function triggerCSVDownload(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // CSV 변환 헬퍼 (따옴표/쉼표 처리)
        function escapeCSVField(value) {
            let str = String(value || '');
            str = str.replace(/"/g, '""'); // Escape double quotes
            if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                str = `"${str}"`; // Wrap fields with commas, newlines, or quotes
            }
            return str;
        }

        // 견본 CSV 다운로드
        document.getElementById('download-csv-btn').addEventListener('click', () => {
            const headers = [
                "corporation", "department", "team", "name", "leader", "members",
                "kickoff", "type", "status",
                "dmaic_d", "dmaic_m", "dmaic_a", "dmaic_i", "dmaic_c",
                "score_potential", "score_strategy", "score_effect", 
                "score_ripple", "score_feasibility", "score_urgency"
            ];
            
            const exampleData = [
                "ATEC", "경영기획", "기획팀", "본사 프로세스 개선", "김본사", "이경영,박기획",
                "2025-04-01", "6σ", "분석",
                "1.0", "1.0", "0.5", "0", "0",
                "9", "18", "9", "9", "9", "9"
            ].map(escapeCSVField); // 예시 데이터도 이스케이프 처리
            
            let csvContent = "\uFEFF"; 
            csvContent += headers.join(",") + "\n";
            csvContent += exampleData.join(",") + "\n";

            triggerCSVDownload(csvContent, "projects_template.csv");
        });

        // CSV 업로드 버튼 클릭 시 input[type=file] 트리거
        document.getElementById('upload-csv-btn').addEventListener('click', () => {
            document.getElementById('csv-upload-input').click();
        });

        // CSV 파일 선택 시 처리
        document.getElementById('csv-upload-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                parseCSV(file);
            }
            event.target.value = null;
        });

        // CSV 파싱 및 일괄 등록
        function parseCSV(file) {
            const reader = new FileReader();
            const statusEl = document.getElementById('upload-status');
            
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split(/\r\n|\n/);
                
                if (lines.length < 2) {
                    statusEl.textContent = "오류: CSV 파일이 비어있거나 헤더만 있습니다.";
                    statusEl.className = "mb-4 text-sm text-red-600";
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const projects = [];
                const invalidProjects = []; // 담당자 모드일 때 다른 법인 데이터

                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue; 

                    // 간단한 CSV 파서 (따옴표 안의 쉼표 무시)
                    const data = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/g).map(field => {
                        let f = field.trim();
                        if (f.startsWith('"') && f.endsWith('"')) {
                            f = f.substring(1, f.length - 1).replace(/""/g, '"');
                        }
                        return f;
                    });

                    if (data.length < headers.length) {
                        console.warn(`Skipping line ${i+1}: Data length (${data.length}) does not match header length (${headers.length}).`);
                        continue; 
                    }
                    
                    const projectData = {};
                    headers.forEach((header, index) => {
                        projectData[header] = data[index] || '';
                    });

                    // 담당자 모드일 경우, 법인명 검증
                    if (currentUserRole === 'user' && projectData.corporation !== currentUserCorporation) {
                        invalidProjects.push(projectData.name || `(Line ${i+1})`);
                        continue; // 이 과제는 등록하지 않고 건너뜀
                    }

                    const scores = [
                        parseInt(projectData.score_potential || 1),
                        parseInt(projectData.score_strategy || 1),
                        parseInt(projectData.score_effect || 1),
                        parseInt(projectData.score_ripple || 1),
                        parseInt(projectData.score_feasibility || 1),
                        parseInt(projectData.score_urgency || 1)
                    ];
                    const totalScore = scores.reduce((sum, val) => sum + val, 0);
                    projectData.grade = calculateGrade(totalScore);
                    projectData.score_total = totalScore;
                    
                    // 숫자형 변환
                    projectData.dmaic_d = parseFloat(projectData.dmaic_d || 0);
                    projectData.dmaic_m = parseFloat(projectData.dmaic_m || 0);
                    projectData.dmaic_a = parseFloat(projectData.dmaic_a || 0);
                    projectData.dmaic_i = parseFloat(projectData.dmaic_i || 0);
                    projectData.dmaic_c = parseFloat(projectData.dmaic_c || 0);
                    projectData.score_potential = scores[0];
                    projectData.score_strategy = scores[1];
                    projectData.score_effect = scores[2];
                    projectData.score_ripple = scores[3];
                    projectData.score_feasibility = scores[4];
                    projectData.score_urgency = scores[5];

                    projects.push(projectData);
                }

                let successMessage = "";
                let errorMessage = "";

                if (projects.length > 0) {
                    statusEl.textContent = "업로드 중... (0%)";
                    statusEl.className = "mb-4 text-sm text-blue-600";
                    try {
                        const batch = writeBatch(db);
                        projects.forEach((project) => {
                            const docRef = doc(getProjectsCol()); 
                            batch.set(docRef, project);
                        });
                        
                        await batch.commit();
                        successMessage = `성공: ${projects.length}개의 과제가 일괄 등록되었습니다.`;
                    } catch (error) {
                        console.error("CSV batch upload error:", error);
                        errorMessage = `오류: 업로드 중 문제가 발생했습니다. ${error.message}`;
                    }
                } else if (invalidProjects.length === 0) {
                    errorMessage = "오류: 유효한 데이터를 찾을 수 없습니다.";
                }

                if (invalidProjects.length > 0) {
                    errorMessage += ` 다음 ${invalidProjects.length}개 과제는 소속 법인이 달라 제외되었습니다: ${invalidProjects.slice(0,3).join(', ')}...`;
                }

                statusEl.textContent = successMessage + " " + errorMessage;
                statusEl.className = `mb-4 text-sm ${errorMessage ? 'text-red-600' : 'text-green-600'}`;

            };

            reader.onerror = () => {
                statusEl.textContent = "오류: 파일을 읽을 수 없습니다.";
                statusEl.className = "mb-4 text-sm text-red-600";
            };

            reader.readAsText(file, 'UTF-8'); 
        }


        // --- 6. 시뮬레이션 기능 (관리자 전용) ---

        // DMAIC 계층 규칙을 따르는 시뮬레이션 데이터 생성
        function generateHierarchicalDMAIC(status) {
            let dmaic = { d: 0, m: 0, a: 0, i: 0, c: 0 };
            const randomProgress = () => (Math.random() * 0.9).toFixed(1) * 1.0; // 0.0 ~ 0.9

            switch (status) {
                case '완료':
                    dmaic = { d: 1.0, m: 1.0, a: 1.0, i: 1.0, c: 1.0 };
                    break;
                case '관리':
                    dmaic = { d: 1.0, m: 1.0, a: 1.0, i: 1.0, c: randomProgress() };
                    break;
                case '개선':
                    dmaic = { d: 1.0, m: 1.0, a: 1.0, i: randomProgress(), c: 0 };
                    break;
                case '분석':
                    dmaic = { d: 1.0, m: 1.0, a: randomProgress(), i: 0, c: 0 };
                    break;
                case '측정':
                    dmaic = { d: 1.0, m: randomProgress(), a: 0, i: 0, c: 0 };
                    break;
                case '정의':
                    dmaic = { d: randomProgress(), m: 0, a: 0, i: 0, c: 0 };
                    break;
                case '미실행':
                default:
                    dmaic = { d: 0, m: 0, a: 0, i: 0, c: 0 };
                    break;
            }
            return dmaic;
        }

        // 데이터 생성 (수정된 로직 사용)
        document.getElementById('run-simulation-btn').addEventListener('click', async () => {
            if (currentUserRole !== 'admin') {
                showAlertModal("이 기능은 관리자만 사용할 수 있습니다.");
                return;
            }
            try {
                const batch = writeBatch(db);
                
                const corporations = ["ATEC", "ATEC SYSTEM", "ATEC COMPUTER", "ATEC MOBILITY", "ATEC C&", "ATEC auto"];
                const types = ["6σ", "6S", "R&D", "AI"];
                const statuses = ["미실행", "정의", "측정", "분석", "개선", "관리", "완료"];
                const leaders = ["김철수", "이영희", "박갑동", "최정민", "한유진"];
                
                // 1. 가상 과제 20개 생성
                for (let i = 0; i < 20; i++) {
                    const docRef = doc(getProjectsCol());
                    
                    const status = statuses[Math.floor(Math.random() * statuses.length)];
                    const dmaic = generateHierarchicalDMAIC(status);

                    const scores = [
                        [1,3,9][Math.floor(Math.random() * 3)],
                        [1,6,18][Math.floor(Math.random() * 3)],
                        [1,3,9][Math.floor(Math.random() * 3)],
                        [1,3,9][Math.floor(Math.random() * 3)],
                        [1,3,9][Math.floor(Math.random() * 3)],
                        [1,3,9][Math.floor(Math.random() * 3)]
                    ];
                    const totalScore = scores.reduce((sum, val) => sum + val, 0);
                    const month = Math.floor(Math.random() * 12) + 1; // 1-12월

                    const project = {
                        corporation: corporations[Math.floor(Math.random() * corporations.length)],
                        team: `테스트팀 ${i+1}`,
                        name: `가상 프로젝트 ${i+1}`,
                        leader: leaders[Math.floor(Math.random() * leaders.length)],
                        kickoff: `2025-${String(month).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`,
                        type: types[Math.floor(Math.random() * types.length)],
                        status: status,
                        dmaic_d: dmaic.d,
                        dmaic_m: dmaic.m,
                        dmaic_a: dmaic.a,
                        dmaic_i: dmaic.i,
                        dmaic_c: dmaic.c,
                        score_potential: scores[0],
                        score_strategy: scores[1],
                        score_effect: scores[2],
                        score_ripple: scores[3],
                        score_feasibility: scores[4],
                        score_urgency: scores[5],
                        score_total: totalScore,
                        grade: calculateGrade(totalScore)
                    };
                    batch.set(docRef, project);
                }

                // 2. 가상 벨트 인원 30명 생성
                const grades = ["MBB", "BB", "GB", "AI"];
                const names = ["김MBB", "이BB", "박GB", "최AI", "정아무개", "윤테스트", "한시뮬"];
                
                for (let i = 0; i < 30; i++) {
                    const docRef = doc(getBeltsCol());
                    const belt = {
                        corporation: corporations[Math.floor(Math.random() * corporations.length)],
                        name: `${names[Math.floor(Math.random() * names.length)]} ${i+1}`,
                        grade: grades[Math.floor(Math.random() * grades.length)],
                    };
                    batch.set(docRef, belt);
                }

                await batch.commit();
                showAlertModal("시뮬레이션 데이터 20개 과제, 30명 인원이 생성되었습니다.");

            } catch (error) {
                console.error("Simulation data creation error:", error);
                showAlertModal(`데이터 생성 중 오류 발생: ${error.message}`);
            }
        });

        // 전체 삭제
        document.getElementById('delete-all-btn').addEventListener('click', async () => {
            if (currentUserRole !== 'admin') {
                showAlertModal("이 기능은 관리자만 사용할 수 있습니다.");
                return;
            }
            try {
                const batch = writeBatch(db);
                
                // 관리자는 전체 삭제
                if (currentUserRole === 'admin') {
                    const projectsSnapshot = await getDocs(getProjectsCol());
                    projectsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    const beltsSnapshot = await getDocs(getBeltsCol());
                    beltsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    showAlertModal("모든 데이터가 삭제되었습니다.");
                } else {
                     showAlertModal("이 기능은 관리자만 사용할 수 있습니다.");
                }

            } catch (error) {
                console.error("Simulation data deletion error:", error);
                showAlertModal(`데이터 삭제 중 오류 발생: ${error.message}`);
            }
        });


        // --- 7. 데이터 저장 & 로그아웃 (요약본 + 로우 데이터) ---

        // 프로젝트 요약 CSV 생성
        function generateProjectSummaryCSV() {
            // getProjectSummaryStats는 이미 currentUserRole을 인지하고 필터링된 데이터를 반환함
            const { stats, totals, corporations } = getProjectSummaryStats(localProjectsCache);
            const headers = ["법인명", "6σ (건)", "6S (건)", "R&D (건)", "AI (건)", "총 과제 (건)", "총 점수"];
            
            let csv = "\uFEFF"; // BOM
            csv += headers.join(',') + '\n';

            corporations.forEach(corp => {
                const data = stats[corp];
                const row = [
                    escapeCSVField(corp),
                    data["6σ"],
                    data["6S"],
                    data["R&D"],
                    data["AI"],
                    data.total,
                    data.score
                ];
                csv += row.join(',') + '\n';
            });

            // 합계 행
            const totalRow = [
                escapeCSVField("합계"),
                totals["6σ"],
                totals["6S"],
                totals["R&D"],
                totals["AI"],
                totals.total,
                totals.score
            ];
            csv += totalRow.join(',') + '\n';
            
            return csv;
        }

        // 벨트 요약 CSV 생성
        function generateBeltSummaryCSV() {
            // getBeltSummaryStats는 이미 currentUserRole을 인지하고 필터링된 데이터를 반환함
            const { stats, totals, corporations } = getBeltSummaryStats(localBeltsCache);
            const headers = ["법인명", "MBB (명)", "BB (명)", "GB (명)", "AI (명)", "총 인원 (명)"];
            
            let csv = "\uFEFEFF"; // BOM
            csv += headers.join(',') + '\n';

            corporations.forEach(corp => {
                const data = stats[corp];
                const row = [
                    escapeCSVField(corp),
                    data.MBB,
                    data.BB,
                    data.GB,
                    data.AI,
                    data.total
                ];
                csv += row.join(',') + '\n';
            });

            // 합계 행
            const totalRow = [
                escapeCSVField("합계"),
                totals.MBB,
                totals.BB,
                totals.GB,
                totals.AI,
                totals.total
            ];
            csv += totalRow.join(',') + '\n';
            
            return csv;
        }

        // 프로젝트 로우 데이터 CSV 생성
        function generateProjectRawDataCSV() {
            // localProjectsCache는 이미 필터링된 데이터임
            if (localProjectsCache.length === 0) return "";
            
            // 모든 객체의 키를 수집하여 헤더 순서 고정
            const allKeys = localProjectsCache.reduce((keys, item) => {
                Object.keys(item).forEach(key => {
                    if (!keys.includes(key)) keys.push(key);
                });
                return keys;
            }, []);

            const filteredHeaders = allKeys.filter(h => h !== 'id'); 
            
            let csv = "\uFEFF"; // BOM
            csv += filteredHeaders.map(escapeCSVField).join(',') + '\n';

            localProjectsCache.forEach(project => {
                const row = filteredHeaders.map(header => {
                    return escapeCSVField(project[header]);
                });
                csv += row.join(',') + '\n';
            });
            
            return csv;
        }

        // 벨트 로우 데이터 CSV 생성
        function generateBeltRawDataCSV() {
            // localBeltsCache는 이미 필터링된 데이터임
            if (localBeltsCache.length === 0) return "";

            const headers = ["corporation", "name", "grade"]; // 'id' 제외하고 순서 고정

            let csv = "\uFEFF"; // BOM
            csv += headers.map(escapeCSVField).join(',') + '\n';
            
            localBeltsCache.forEach(belt => {
                const row = headers.map(header => {
                    return escapeCSVField(belt[header]);
                });
                csv += row.join(',') + '\n';
            });

            return csv;
        }


        // 데이터 저장 및 로그아웃 (총 4개 파일)
        async function exportDataAndLogout() {
            try {
                // 1. Projects 요약 CSV 생성
                const projectsSummaryCSV = generateProjectSummaryCSV();
                triggerCSVDownload(projectsSummaryCSV, 'project_summary_export.csv');

                // 2. Belts 요약 CSV 생성
                const beltsSummaryCSV = generateBeltSummaryCSV();
                triggerCSVDownload(beltsSummaryCSV, 'belt_summary_export.csv');

                // 3. Projects 로우 데이터 CSV 생성
                const projectsRawCSV = generateProjectRawDataCSV();
                if (projectsRawCSV) {
                    triggerCSVDownload(projectsRawCSV, 'projects_raw_data_export.csv');
                }

                // 4. Belts 로우 데이터 CSV 생성
                const beltsRawCSV = generateBeltRawDataCSV();
                if (beltsRawCSV) {
                    triggerCSVDownload(beltsRawCSV, 'belts_raw_data_export.csv');
                }

                // 5. 로그아웃 (페이지 새로고침)
                setTimeout(() => {
                    location.reload();
                }, 500);

            } catch (error) {
                console.error("Error exporting data:", error);
                showAlertModal(`데이터 저장 중 오류 발생: ${error.message}`);
            }
        }


        // --- 8. 유틸리티 함수 (탭, 모달) ---

        // 탭 전환
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');

        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.dataset.tab;

                tabLinks.forEach(link => link.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                link.classList.add('active');
                document.getElementById(targetId).classList.add('active');
            });
        });

        // 모달 열기
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        // 모달 닫기 (배경 클릭 시)
        function closeModal(modalId, event) {
            if (event && event.target === event.currentTarget) {
                document.getElementById(modalId).classList.add('hidden');
            }
        }

        // 모달 G (버튼 클릭 시 - 함수명 분리)
        function closeModalFromButton(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // 커스텀 알림 모달
        function showAlertModal(message) {
            document.getElementById('alert-message').textContent = message;
            openModal('alert-modal');
        }

        // --- 글로벌 이벤트 리스너 ---
        document.getElementById('project-form').addEventListener('submit', saveProject);
        document.getElementById('belt-form').addEventListener('submit', saveBelt);

        // 로그인 버튼
        document.getElementById('admin-login-btn').addEventListener('click', () => openModal('admin-login-modal'));
        document.getElementById('user-login-btn').addEventListener('click', () => openModal('user-login-modal'));

        // 로그인 폼
        document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
        document.getElementById('user-login-form').addEventListener('submit', handleUserLogin);

        // 로그아웃 버튼
        document.getElementById('export-logout-btn').addEventListener('click', exportDataAndLogout);

        // 진척율 현황 대시보드 필터
        document.getElementById('progress-corp-filter').addEventListener('change', loadProgressDashboard);
        document.getElementById('progress-type-filter').addEventListener('change', loadProgressDashboard);

        window.closeModal = closeModal;
        window.closeModalFromButton = closeModalFromButton;

    </script>

</body>
</html>

